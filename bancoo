# criar_banco_rpg.py
import sqlite3
import os
from pathlib import Path

class DatabaseCreator:
    def __init__(self):
        # Define onde o banco de dados ser√° armazenado
        self.db_dir = Path("banco")
        self.db_path = self.db_dir / "rpg.db"
        
    def create_database(self):
        """Cria toda a estrutura do banco de dados com dados iniciais"""
        try:
            # Garante que a pasta do banco existe
            self.db_dir.mkdir(exist_ok=True)
            
            # Remove vers√£o anterior para come√ßar do zero (em desenvolvimento)
            if self.db_path.exists():
                self.db_path.unlink()
            
            # Conecta ao banco e prepara o ambiente
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute("PRAGMA foreign_keys = ON")  # Ativa integridade referencial
            
            # ==================== CRIA√á√ÉO DAS TABELAS ====================
            
            # Tabela dos Jogadores - Quem joga no sistema
            cursor.execute("""
                CREATE TABLE Jogador (
                    id_jogador INTEGER PRIMARY KEY AUTOINCREMENT,  -- Identificador √∫nico
                    nome_usuario TEXT NOT NULL UNIQUE,             -- Nome que aparece no jogo
                    email TEXT NOT NULL UNIQUE,                    -- Para login e recupera√ß√£o
                    senha TEXT NOT NULL,                           -- Protege a conta
                    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP -- Quando se cadastrou
                )
            """)
            
            # Tabela dos Personagens - Her√≥is controlados pelos jogadores
            cursor.execute("""
                CREATE TABLE Personagem (
                    id_personagem INTEGER PRIMARY KEY AUTOINCREMENT,
                    id_jogador INTEGER NOT NULL,                   -- Dono do personagem
                    nome TEXT NOT NULL,                            -- Nome do her√≥i
                    classe TEXT NOT NULL,                          -- Guerreiro, Mago, Ladino, etc.
                    nivel INTEGER DEFAULT 1 CHECK(nivel BETWEEN 1 AND 100), -- Progress√£o
                    forca INTEGER DEFAULT 10,                      -- Atributo f√≠sico
                    destreza INTEGER DEFAULT 10,                   -- Agilidade e precis√£o
                    constituicao INTEGER DEFAULT 10,               -- Resist√™ncia e sa√∫de
                    inteligencia INTEGER DEFAULT 10,               -- Poder m√°gico
                    pontos_vida INTEGER DEFAULT 100,               -- HP atual
                    pontos_vida_max INTEGER DEFAULT 100,           -- HP m√°ximo
                    pontos_mana INTEGER DEFAULT 50,                -- MP atual
                    pontos_mana_max INTEGER DEFAULT 50,            -- MP m√°ximo
                    ponto_fraco TEXT,                              -- Vulnerabilidades
                    experiencia INTEGER DEFAULT 0,                 -- XP acumulado
                    experiencia_proximo_nivel INTEGER DEFAULT 100, -- XP para subir n√≠vel
                    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,
                    id_local_atual INTEGER,                        -- Onde est√° agora
                    CONSTRAINT fk_personagem_jogador FOREIGN KEY (id_jogador) REFERENCES Jogador(id_jogador)
                )
            """)
            
            # Cat√°logo de Habilidades - Todas as skills dispon√≠veis no jogo
            cursor.execute("""
                CREATE TABLE Habilidade (
                    id_habilidade INTEGER PRIMARY KEY AUTOINCREMENT,
                    nome TEXT NOT NULL,                            -- Nome da habilidade
                    descricao TEXT,                                -- O que ela faz
                    tipo_habilidade TEXT,                          -- F√≠sico, Magia, Cura, etc.
                    custo INTEGER DEFAULT 0,                       -- Custo de mana/energia
                    alcance INTEGER DEFAULT 1,                     -- Dist√¢ncia em metros
                    dano INTEGER DEFAULT 0,                        -- Dano base
                    tempo_recarga REAL DEFAULT 0,                  -- Cooldown em segundos
                    alvo TEXT,                                     -- √önico, √Årea, Aliado
                    classe TEXT                                    -- Quem pode usar
                )
            """)
            
            # Liga Personagens com suas Habilidades - O que cada um sabe
            cursor.execute("""
                CREATE TABLE Personagem_Habilidade (
                    id_personagem INTEGER,                         -- Quem tem a habilidade
                    id_habilidade INTEGER,                         -- Qual habilidade
                    tempo_recarga_restante REAL DEFAULT 0,         -- Tempo at√© poder usar de novo
                    PRIMARY KEY (id_personagem, id_habilidade),    -- Combina√ß√£o √∫nica
                    CONSTRAINT fk_ph_personagem FOREIGN KEY (id_personagem) REFERENCES Personagem(id_personagem),
                    CONSTRAINT fk_ph_habilidade FOREIGN KEY (id_habilidade) REFERENCES Habilidade(id_habilidade)
                )
            """)
            
            # Cat√°logo de Itens - Todos os itens do jogo
            cursor.execute("""
                CREATE TABLE Item (
                    id_item INTEGER PRIMARY KEY AUTOINCREMENT,
                    nome TEXT NOT NULL,                            -- Nome do item
                    descricao TEXT,                                -- Descri√ß√£o detalhada
                    tipo TEXT,                                     -- Arma, Armadura, Consum√≠vel
                    qualidade TEXT,                                -- Normal, M√°gica, Superior
                    raridade TEXT,                                 -- Comum, Incomum, Rara
                    valor INTEGER DEFAULT 0,                       -- Pre√ßo em lojas
                    efeito TEXT                                    -- O que o item faz
                )
            """)
            
            # Invent√°rios dos Personagens - Bolsa de cada her√≥i
            cursor.execute("""
                CREATE TABLE Inventario (
                    id_inventario INTEGER PRIMARY KEY AUTOINCREMENT,
                    id_personagem INTEGER NOT NULL UNIQUE,         -- Cada personagem tem 1 invent√°rio
                    capacidade INTEGER DEFAULT 20,                 -- Quantos itens cabem
                    CONSTRAINT fk_inventario_personagem FOREIGN KEY (id_personagem) REFERENCES Personagem(id_personagem)
                )
            """)
            
            # Itens dentro dos Invent√°rios - O que cada um carrega
            cursor.execute("""
                CREATE TABLE Inventario_Item (
                    id_inventario INTEGER,                         -- De quem √© o invent√°rio
                    id_item INTEGER,                               -- Qual item est√° guardado
                    quantidade INTEGER DEFAULT 1,                  -- Quantos tem
                    PRIMARY KEY (id_inventario, id_item),          -- N√£o pode repetir item no mesmo invent√°rio
                    CONSTRAINT fk_ii_inventario FOREIGN KEY (id_inventario) REFERENCES Inventario(id_inventario),
                    CONSTRAINT fk_ii_item FOREIGN KEY (id_item) REFERENCES Item(id_item)
                )
            """)
            
            # Cat√°logo de Inimigos - Advers√°rios do jogo
            cursor.execute("""
                CREATE TABLE Inimigo (
                    id_inimigo INTEGER PRIMARY KEY AUTOINCREMENT,
                    nome TEXT NOT NULL,                            -- Nome do inimigo
                    tipo TEXT,                                     -- Humanoide, Besta, etc.
                    pontos_vida INTEGER DEFAULT 50,                -- HP atual
                    pontos_vida_max INTEGER DEFAULT 50,            -- HP m√°ximo
                    ataque INTEGER DEFAULT 10,                     -- Poder de ataque
                    defesa INTEGER DEFAULT 5,                      -- Prote√ß√£o
                    fraqueza TEXT,                                 -- Elemento vulner√°vel
                    experiencia_concedida INTEGER DEFAULT 25,      -- XP que d√° ao ser derrotado
                    descricao TEXT                                 -- Hist√≥ria/apar√™ncia
                )
            """)
            
            # Registro de Combates - Hist√≥rico de batalhas
            cursor.execute("""
                CREATE TABLE Combate (
                    id_combate INTEGER PRIMARY KEY AUTOINCREMENT,
                    id_personagem INTEGER,                         -- Quem lutou
                    id_inimigo INTEGER,                            -- Contra quem lutou
                    resultado TEXT CHECK(resultado IN ('Vit√≥ria', 'Derrota', 'Fuga')), -- Como terminou
                    dano_causado INTEGER DEFAULT 0,                -- Dano total dado
                    dano_recebido INTEGER DEFAULT 0,               -- Dano total tomado
                    data_combate DATETIME DEFAULT CURRENT_TIMESTAMP, -- Quando aconteceu
                    CONSTRAINT fk_combate_personagem FOREIGN KEY (id_personagem) REFERENCES Personagem(id_personagem),
                    CONSTRAINT fk_combate_inimigo FOREIGN KEY (id_inimigo) REFERENCES Inimigo(id_inimigo)
                )
            """)
            
            # Miss√µes Dispon√≠veis - Quests do jogo
            cursor.execute("""
                CREATE TABLE Missao (
                    id_missao INTEGER PRIMARY KEY AUTOINCREMENT,
                    titulo TEXT NOT NULL,                          -- Nome da miss√£o
                    descricao TEXT,                                -- O que precisa fazer
                    localizacao TEXT,                              -- Onde acontece
                    recompensa TEXT,                               -- O que ganha ao completar
                    status TEXT CHECK(status IN ('Dispon√≠vel', 'Em Andamento', 'Conclu√≠da', 'Falhou')) DEFAULT 'Dispon√≠vel',
                    passos_total INTEGER DEFAULT 1,                -- Quantas etapas tem
                    passos_concluidos INTEGER DEFAULT 0,           -- Quantas j√° fez
                    data_inicio DATETIME,                          -- Quando come√ßou
                    data_conclusao DATETIME                        -- Quando terminou
                )
            """)
            
            # Progresso dos Jogadores nas Miss√µes - Quem est√° fazendo o qu√™
            cursor.execute("""
                CREATE TABLE Jogador_Missao (
                    id_jogador INTEGER,                            -- Quem aceitou a miss√£o
                    id_missao INTEGER,                             -- Qual miss√£o
                    progresso INTEGER DEFAULT 0,                   -- Porcentagem ou etapas
                    PRIMARY KEY (id_jogador, id_missao),           -- N√£o pode repetir miss√£o para mesmo jogador
                    CONSTRAINT fk_jm_jogador FOREIGN KEY (id_jogador) REFERENCES Jogador(id_jogador),
                    CONSTRAINT fk_jm_missao FOREIGN KEY (id_missao) REFERENCES Missao(id_missao)
                )
            """)
            
            # Log do Sistema - Registro de eventos importantes
            cursor.execute("""
                CREATE TABLE Sistema_Log (
                    id_log INTEGER PRIMARY KEY AUTOINCREMENT,
                    tipo TEXT,                                     -- Info, Aviso, Erro
                    mensagem TEXT,                                 -- O que aconteceu
                    data_log DATETIME DEFAULT CURRENT_TIMESTAMP    -- Quando aconteceu
                )
            """)
            
            conn.commit()
            print("‚úÖ Todas as tabelas criadas com sucesso!")
            
            # ==================== DADOS INICIAIS PARA TESTE ====================
            
            self._insert_initial_data(cursor, conn)
            
            # ==================== OTIMIZA√á√ÉO DO BANCO ====================
            
            self._create_indexes(cursor, conn)
            
            conn.close()
            
            print("‚úÖ Banco de dados RPG criado com sucesso!")
            print("‚úÖ Estrutura completa!")
            print("‚úÖ Dados iniciais inseridos!")
            return True
            
        except sqlite3.Error as e:
            print(f"‚ùå Erro ao criar banco de dados: {e}")
            return False

    def _insert_initial_data(self, cursor, conn):
        """Popula o banco com dados iniciais para testar o jogo"""
        try:
            # Habilidades - As skills que os personagens podem aprender
            habilidades = [
                # Habilidades de Guerreiro
                (1, 'Corte Certeiro', 'Golpe preciso que ignora parte da defesa', 'F√≠sico', 0, 1, 15, 2.0, '√önico', 'Guerreiro'),
                (2, 'Investida Her√≥ica', 'Avan√ßo r√°pido com dano aumentado', 'F√≠sico', 5, 3, 12, 4.0, '√önico', 'Guerreiro'),
                (3, 'Barreira Impenetr√°vel', 'Dobra a defesa por 2 turnos', 'Defesa', 10, 0, 0, 8.0, 'Pr√≥prio', 'Guerreiro'),
                (4, 'F√∫ria do Guerreiro', 'Ataque em √°rea com chance de atordoar', 'F√≠sico', 15, 2, 25, 6.0, '√Årea', 'Guerreiro'),
                
                # Habilidades de Mago
                (5, 'Bola de Fogo', 'Esfera de fogo que queima m√∫ltiplos alvos', 'Magia', 20, 4, 30, 3.0, '√Årea', 'Mago'),
                (6, 'Raio de Gelo', 'Jato congelante que reduz velocidade', 'Magia', 15, 3, 25, 2.5, '√önico', 'Mago'),
                (7, 'Cura Leve', 'Restaura pontos de vida do alvo', 'Cura', 10, 2, -20, 5.0, 'Aliado', 'Mago'),
                (8, 'Escudo Arcano', 'Prote√ß√£o m√°gica contra dano', 'Defesa', 8, 0, 0, 4.0, 'Pr√≥prio', 'Mago'),
                
                # Habilidades de Ladino
                (9, 'Ataque Furtivo', 'Dano extra quando n√£o detectado', 'F√≠sico', 0, 1, 20, 3.0, '√önico', 'Ladino'),
                (10, 'Esquiva √Ågil', 'Aumenta evas√£o significativamente', 'Defesa', 5, 0, 0, 6.0, 'Pr√≥prio', 'Ladino')
            ]
            
            cursor.executemany("""
                INSERT INTO Habilidade (id_habilidade, nome, descricao, tipo_habilidade, custo, alcance, dano, tempo_recarga, alvo, classe)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, habilidades)
            
            # Itens - Equipamentos e consum√≠veis dispon√≠veis
            itens = [
                # Consum√≠veis
                (1, 'Po√ß√£o de Vida', 'Restaura 35 pontos de vida', 'Consum√≠vel', 'Normal', 'Comum', 25, 'Cura 35 PV'),
                (2, 'Po√ß√£o de Mana', 'Restaura 25 pontos de mana', 'Consum√≠vel', 'Normal', 'Comum', 30, 'Restaura 25 PM'),
                (3, 'Elixir de For√ßa', 'Aumenta a for√ßa temporariamente', 'Consum√≠vel', 'M√°gica', 'Incomum', 50, '+5 For√ßa por 1 hora'),
                (10, 'Po√ß√£o de Veneno', 'Causa dano por veneno', 'Consum√≠vel', 'Normal', 'Incomum', 40, '5 de dano por 3 turnos'),
                
                # Armas
                (4, 'Espada Longa', 'Uma espada confi√°vel para combate', 'Arma', 'Comum', 'Comum', 100, 'Dano: 1d8'),
                (5, 'Cajado Arcano', 'Amplifica poderes m√°gicos', 'Arma', 'M√°gica', 'Incomum', 200, '+10% poder m√°gico'),
                (8, 'Arco Longo', 'Arco para ataques √† dist√¢ncia', 'Arma', 'Comum', 'Comum', 80, 'Alcance: 30m'),
                
                # Armaduras
                (6, 'Armadura de Couro', 'Prote√ß√£o b√°sica para aventureiros', 'Armadura', 'Comum', 'Comum', 75, 'Defesa: +2'),
                (7, 'Armadura de Placas', 'Prote√ß√£o pesada para guerreiros', 'Armadura', 'Superior', 'Rara', 300, 'Defesa: +5'),
                
                # Acess√≥rios
                (9, 'Amuleto da Sorte', 'Aumenta chances de acerto cr√≠tico', 'Acess√≥rio', 'M√°gica', 'Rara', 500, '+5% cr√≠tico')
            ]
            
            cursor.executemany("""
                INSERT INTO Item (id_item, nome, descricao, tipo, qualidade, raridade, valor, efeito)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, itens)
            
            # Inimigos - Os advers√°rios que os jogadores enfrentar√£o
            inimigos = [
                (1, 'L√≠der dos Assaltantes', 'Humanoide', 60, 60, 12, 8, 'Luz', 50, 'Chefe dos bandidos da regi√£o'),
                (2, 'Espi√£o do Conselho', 'Humanoide', 45, 45, 10, 12, 'Verdade', 35, 'Infiltrado nas altas esferas'),
                (3, 'Guarda Corrompido', 'Humanoide', 55, 55, 14, 10, 'Honra', 45, 'Ex-membro da guarda real'),
                (4, 'Lobo Sombrio', 'Besta', 40, 40, 8, 6, 'Fogo', 25, 'Lobo corrompido pela escurid√£o'),
                (5, 'Aranha Gigante', 'Besta', 50, 50, 10, 5, 'Gelo', 30, 'Aranha de tamanho anormal')
            ]
            
            cursor.executemany("""
                INSERT INTO Inimigo (id_inimigo, nome, tipo, pontos_vida, pontos_vida_max, ataque, defesa, fraqueza, experiencia_concedida, descricao)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, inimigos)
            
            # Miss√µes - As aventuras dispon√≠veis
            missoes = [
                (1, 'Proteger a Vila', 'Derrote os bandidos que amea√ßam a paz da vila', 'Vila de Eldoria', '100 moedas de ouro e reputa√ß√£o', 'Dispon√≠vel', 3, 0, None, None),
                (2, 'Ca√ßa √† Besta da Floresta', 'Elimine a criatura que assombra a floresta', 'Floresta Sombria', '150 moedas e item raro', 'Dispon√≠vel', 2, 0, None, None),
                (3, 'Recuperar o Artefato Perdido', 'Encontre o artefato nas ru√≠nas antigas', 'Ru√≠nas Antigas', '200 moedas e fama', 'Dispon√≠vel', 4, 0, None, None)
            ]
            
            cursor.executemany("""
                INSERT INTO Missao (id_missao, titulo, descricao, localizacao, recompensa, status, passos_total, passos_concluidos, data_inicio, data_conclusao)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, missoes)
            
            conn.commit()
            print("‚úÖ Dados iniciais inseridos com sucesso!")
            
        except sqlite3.Error as e:
            print(f"‚ùå Erro ao inserir dados iniciais: {e}")
            raise

    def _create_indexes(self, cursor, conn):
        """Cria √≠ndices para acelerar as consultas mais frequentes"""
        try:
            indexes = [
                # √çndices para buscas r√°pidas de personagens
                "CREATE INDEX IF NOT EXISTS idx_personagem_jogador ON Personagem(id_jogador)",
                "CREATE INDEX IF NOT EXISTS idx_personagem_classe ON Personagem(classe)",
                "CREATE INDEX IF NOT EXISTS idx_personagem_nivel ON Personagem(nivel)",
                
                # √çndices para invent√°rio e itens
                "CREATE INDEX IF NOT EXISTS idx_inventario_personagem ON Inventario(id_personagem)",
                "CREATE INDEX IF NOT EXISTS idx_item_tipo ON Item(tipo)",
                
                # √çndices para miss√µes e progresso
                "CREATE INDEX IF NOT EXISTS idx_missao_status ON Missao(status)",
                
                # √çndices para combates e hist√≥rico
                "CREATE INDEX IF NOT EXISTS idx_combate_data ON Combate(data_combate)",
                "CREATE INDEX IF NOT EXISTS idx_combate_personagem ON Combate(id_personagem)",
                
                # √çndices para habilidades e inimigos
                "CREATE INDEX IF NOT EXISTS idx_habilidade_classe ON Habilidade(classe)",
                "CREATE INDEX IF NOT EXISTS idx_inimigo_tipo ON Inimigo(tipo)",
                
                # √çndices para login e usu√°rios
                "CREATE INDEX IF NOT EXISTS idx_jogador_email ON Jogador(email)",
                "CREATE INDEX IF NOT EXISTS idx_jogador_usuario ON Jogador(nome_usuario)"
            ]
            
            for index in indexes:
                cursor.execute(index)
            
            conn.commit()
            print("‚úÖ √çndices criados com sucesso!")
            
        except sqlite3.Error as e:
            print(f"‚ùå Erro ao criar √≠ndices: {e}")
            raise

if __name__ == "__main__":
    # Cria uma inst√¢ncia do criador de banco e executa
    creator = DatabaseCreator()
    success = creator.create_database()
    
    if success:
        print("\n" + "="*60)
        print("üéÆ BANCO DE DADOS RPG CRIADO COM SUCESSO!")
        print("="*60)
        print("üìä Estrutura criada:")
        print("   ‚úÖ 10 tabelas principais")
        print("   ‚úÖ Dados iniciais para teste")
        print("   ‚úÖ √çndices de performance")
        print("\nüëâ Agora execute o jogo RPG!")
        print("üëâ O banco est√° 100% compat√≠vel!")
        print("="*60)
    else:
        print("\n‚ùå Falha ao criar o banco de dados.")